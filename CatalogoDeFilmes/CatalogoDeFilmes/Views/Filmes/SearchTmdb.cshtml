@model CatalogoDeFilmes.Models.TmdbSearchResponse

@{
    ViewData["Title"] = "Buscar no TMDb";
    var query = ViewBag.Query as string ?? "";
}

<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-search"></i> Buscar Filmes no TMDb</h1>
        <p class="text-muted">Pesquise filmes no banco de dados do The Movie Database para importar para seu catálogo.</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8 offset-md-2">
        <form method="get" asp-action="SearchTmdb">
            <div class="input-group input-group-lg">
                <input type="text" name="query" value="@query" class="form-control" placeholder="Digite o nome do filme..." autofocus required />
                <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Buscar</button>
            </div>
        </form>
    </div>
</div>

@if (ViewBag.Error != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle"></i> @ViewBag.Error
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (!string.IsNullOrEmpty(query))
{
    if (Model?.Results?.Any() == true)
    {
        <div class="mb-3">
            <h5>Resultados para "@query" - Página @Model.Page de @Model.TotalPages</h5>
            <p class="text-muted">Encontrados @Model.Results.Count resultados nesta página</p>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 5%">#</th>
                        <th style="width: 35%">Título</th>
                        <th style="width: 15%">Título Original</th>
                        <th style="width: 12%">Lançamento</th>
                        <th style="width: 10%">Idioma</th>
                        <th style="width: 8%">Nota</th>
                        <th style="width: 15%">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var f in Model.Results)
                    {
                        <tr>
                            <td>@f.Id</td>
                            <td>
                                <strong>@f.Title</strong>
                                @if (!string.IsNullOrEmpty(f.Overview))
                                {
                                    <br /><small class="text-muted">@(f.Overview.Length > 100 ? f.Overview.Substring(0, 100) + "..." : f.Overview)</small>
                                }
                            </td>
                            <td>@f.OriginalTitle</td>
                            <td>
                                @if (!string.IsNullOrEmpty(f.ReleaseDate))
                                {
                                    @DateTime.Parse(f.ReleaseDate).ToString("dd/MM/yyyy")
                                }
                                else
                                {
                                    <span class="text-muted">N/A</span>
                                }
                            </td>
                            <td><span class="badge bg-secondary">@f.OriginalLanguage.ToUpper()</span></td>
                            <td><span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i> @f.VoteAverage.ToString("F1")</span></td>
                            <td>
                                <a asp-action="ImportFromTmdb" asp-route-tmdbId="@f.Id" class="btn btn-sm btn-success">
                                    <i class="bi bi-download"></i> Importar
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (Model.TotalPages > 1)
        {
            <nav aria-label="Paginação de resultados">
                <ul class="pagination justify-content-center">
                    @if (Model.Page > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" asp-action="SearchTmdb" asp-route-query="@query" asp-route-page="@(Model.Page - 1)">
                                <i class="bi bi-chevron-left"></i> Anterior
                            </a>
                        </li>
                    }

                    @{
                        var startPage = Math.Max(1, Model.Page - 2);
                        var endPage = Math.Min(Model.TotalPages, Model.Page + 2);
                    }

                    @if (startPage > 1)
                    {
                        <li class="page-item"><a class="page-link" asp-action="SearchTmdb" asp-route-query="@query" asp-route-page="1">1</a></li>
                        @if (startPage > 2)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                    }

                    @for (int p = startPage; p <= endPage; p++)
                    {
                        <li class="page-item @(p == Model.Page ? "active" : "")">
                            <a class="page-link" asp-action="SearchTmdb" asp-route-query="@query" asp-route-page="@p">@p</a>
                        </li>
                    }

                    @if (endPage < Model.TotalPages)
                    {
                        @if (endPage < Model.TotalPages - 1)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                        <li class="page-item"><a class="page-link" asp-action="SearchTmdb" asp-route-query="@query" asp-route-page="@Model.TotalPages">@Model.TotalPages</a></li>
                    }

                    @if (Model.Page < Model.TotalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" asp-action="SearchTmdb" asp-route-query="@query" asp-route-page="@(Model.Page + 1)">
                                Próxima <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
    else if (string.IsNullOrEmpty(ViewBag.Error as string))
    {
        <div class="alert alert-info">
            <h4 class="alert-heading"><i class="bi bi-info-circle"></i> Nenhum resultado encontrado</h4>
            <p>Não foram encontrados filmes com o termo "@query".</p>
            <hr>
            <p class="mb-0">Tente usar outros termos de busca ou o título em inglês.</p>
        </div>
    }
}
else
{
    <div class="text-center text-muted">
        <i class="bi bi-search" style="font-size: 5rem; opacity: 0.3;"></i>
        <p class="mt-3">Digite um termo de busca acima para começar</p>
    </div>
}
